{% extends 'base.html' %}

{% load static %}

{% block title %}
Translate
{% endblock %}

{% block desc %}
Translate according the instructions -- yo!
{% endblock %}

{% block js %}
    <script type="text/javascript" src="../static/translate-page-mt-version.js"></script>
    <link rel="stylesheet" type="text/css"href="../static/translation-page-mt.css">

    <script type=text/javascript>

      $(document).ready(function(){
        var searchRequest = null;
        var debounceTimeout = null;
        var searchInput = $("#partial");
        var result = '';
        var selecte = 0;
        var outputs = [];
        var highlight = $("#highlight").is(':checked');
        var globkeystrokes = []
        var docstarttime = new Date()

        
        var inputs = []

        var timer1 = 0;
        var timer2 = 0;

        $.getJSON('/getinput', {
                   }, function(data) {
                    // console.log(data.result);
                    inputs=data.result;
                    console.log(inputs)
                    $('#cardscoll').html('')
                    for (i=0; i<inputs.length; i++) {
                      // console.log()
                      $('#cardscoll').append(
                                              `<div class="card bmo">
                                                <div class="card-content">
                                                  <div class="row">
                                                    <div class="col s5 m5">
                                                      <div class="hin_inp transtext" contenteditable="false">`+inputSpan(inputs[i][0])+`</div>
                                                    </div>
                                                    <div class="col s1 m1">
                                                      <br>
                                                      <img src="{% static 'forward.png' %}" style="height:15px">
                                                    </div>
                                                    <div class="col s6 m6">
                                                      <div class="dropcontainer">
                                                        <div class="partcontainer">
                                                          <div class="suggest transtext" contenteditable="false"></div>
                                                          <div class=" partial transtext" contenteditable="true"
                                                          data-tab=0 data-enter=0 data-up=0 data-down=0 data-others=0 data-pgup=0 data-pgdn=0 data-end=0 data-right=0 data-left=0 data-bkspc=0 data-time=0
                                                          >`+inputs[i][1]+`</div>
                                                        </div>
                                                        <div class="dropdown">
                                                        </div>
                                                      </div>
                                                      <div class="perinstr">
                                                          | &nbsp; &nbsp; Select &#8645; Tab &#8594; Enter &#8608; &nbsp; &nbsp; | &nbsp; &nbsp; Page Down &#8609; Page Up &#8607; &nbsp; &nbsp; |
                                                      </div>
                                                    </div>
                                                  </div>
                                                </div>
                                              </div>`
                                            )
                    }

                    $('.bmo').not($('.bmo').first()).addClass('bmo--blur');

                    var searchEvents = function(partial){
                      if (searchRequest)
                        searchRequest.abort()

                      var hin_inp = partial.closest('.bmo').find('.hin_inp')

                      searchRequest =  $.getJSON('/translate_new', {
                          a: strip(hin_inp.text()),
                          b: partial.clone().children().remove().end().text()
                        }, function(data) {
                          // $("#result").text(data.result);
                          console.log(data)
                          result = data.result.split("\n")
                          partialret = data.partial
                          

                          selecte = 0;
                          
                          // All to do with the user input
                          if (selecte >= result.length) {
                            selecte = 0;
                          }

                          if (result[selecte].includes(partial.text())) {
                              partial.closest('.bmo').find('.suggest').text(result[selecte])
                          }
                          
                          var container = $('<div />');

                          var countcontainer = 0
                          finalresult = []
                          for(var i = 0; i < result.length; i++) {
                              var repres = sharedStart(result[i], partialret)
                              if (repres !== "") {
                                container.append('<span id="res'+countcontainer+'" class="res'+countcontainer+' spanres"> ' + repres + '</span>');
                                countcontainer += 1;
                                finalresult.push(result[i])
                              }
                          }

                          result = finalresult

                          partial.closest('.bmo').find('.dropdown').html(container);
                          
                          resetcolors('.res', $('.spanres').length)
                          $('.res' + selecte).css({"background-color": "#eee"})
                          if (countcontainer>1) {
                            partial.closest('.bmo').find('.dropdown').css('visibility', 'visible');
                          }

                          // All to do with the source sentence
                          
                          if (highlight == true) {
                            var attn = data.attn
                            $("span[class^='hin_inp_part']").css("background-color", "transparent");
                            for (m=0; m<attn.length; m++) {
                              
                              if (attn[m] != 0) {
                                partial.closest('.bmo').find('.hin_inp_part' + m).css('background-color', 'rgba(255,0,0,' + attn[m] + ')')
                              }
                              else {
                                partial.closest('.bmo').find('.hin_inp_part' + m).css('background-color', 'rgba(0,255,0,0.5)')
                              }
                            }
                          }
                        });
                    }

                    $('.submittrans').click(function(elem){
                      $('.preloader-background').css('display', 'flex')
                        // searchEvents($(this));
                        $(".partial").each(function() {
                          outputs.push([$(this).closest('.bmo').find('.hin_inp').text(), $(this).text()])
                        })
                        $(this).data("end", parseInt($(this).data("end")) + 1)
                        $.ajax({
                            type: 'POST',
                            url: '/pushoutput',
                            data: {'csrfmiddlewaretoken': '{{ csrf_token }}', 'ops': JSON.stringify(outputs), 'keytimeseries': JSON.stringify(globkeystrokes)},
                            traditional: true,
                            success: function(result) {
                                window.location.href='/preview';
                            }
                        }); 

                    })

                    $(document).on('keydown', function(e) {
                      globkeystrokes.push([e.keyCode || e.which, new Date() - docstarttime])
                    })
                    $(document).on('mousedown', function(e) {
                      globkeystrokes.push([e.keyCode || e.which, new Date() - docstarttime])
                    })

                    $(".partial").on('keydown', function(e){
                      var keyCode = e.keyCode || e.which;

                      

                      if (keyCode == 9) {
                        e.preventDefault();
                        var partial = $(this).clone().children().remove().end().text().split(" ").filter(function(v){return v!==''})
                        var step = partial.length
                        var res = result[selecte].split(" ")[step-1]
                        if (result[selecte].split(" ")[step-1] == partial[step-1]) {
                          res = result[selecte].split(" ")[step]
                        } else {
                          partial.pop()
                        }
                        partial.push(res)
                        $(this).html(partial.join(" ") + " ")
                        $(this).closest('.bmo').find('.suggest').text(result[selecte])
                        placeCaretAtEnd($(this).get(0))
                        $(this).closest('.bmo').find('.dropdown').css('visibility', 'hidden')
                        $(this).data("tab", parseInt($(this).data("tab")) + 1)
                      } else

                      if (keyCode == 13) { 
                        e.preventDefault();
                        $(this).html(result[selecte])
                        $(this).closest('.bmo').find('.suggest').text(result[selecte])
                        placeCaretAtEnd($(this).get(0))
                        $(this).closest('.bmo').find('.dropdown').css('visibility', 'hidden')
                        $(this).data("enter", parseInt($(this).data("enter")) + 1)
                      } else

                      if (keyCode == 40) { 
                        e.preventDefault();
                        if (selecte < $('.spanres').length - 1 )
                          selecte = selecte + 1;
                          resetcolors('.res', $('.spanres').length)
                          $('.res' + selecte).css({"background-color": "#ddd"})
                          $(this).closest('.bmo').find('.suggest').text(result[selecte])
                          $(this).data("down", parseInt($(this).data("down")) + 1)
                      } else
                      if (keyCode == 38) { 
                        e.preventDefault();
                        if (selecte > 0)
                          selecte = selecte - 1;
                          resetcolors('.res', $('.spanres').length)
                          $('.res' + selecte).css({"background-color": "#ddd"})
                          $(this).closest('.bmo').find('.suggest').text(result[selecte])
                          $(this).data("up", parseInt($(this).data("up")) + 1)
                      } else
                      if (keyCode == 34) { 
                        e.preventDefault();
                        // searchEvents($(this));
                        $(this).closest('.bmo').next().find('.partial').focus()
                        $(this).data("pgdn", parseInt($(this).data("pgdn")) + 1)
                      } else 
                      if (keyCode == 33) { 
                        e.preventDefault();
                        // searchEvents($(this));
                        $(this).closest('.bmo').prev().find('.partial').focus()
                        $(this).data("pgup", parseInt($(this).data("pgup")) + 1)
                      } else
                      if (keyCode == 35) { 
                        e.preventDefault();
                        $('.preloader-background').css('display', 'flex')
                        // searchEvents($(this));
                        $(".partial").each(function() {
                          outputs.push([$(this).closest('.bmo').find('.hin_inp').text(), $(this).text()])
                        })
                        console.log(JSON.stringify({'ops': outputs}))
                        $(this).data("end", parseInt($(this).data("end")) + 1)

                        $.ajax({
                            type: 'POST',
                            url: '/pushoutput',
                            data: {'csrfmiddlewaretoken': '{{ csrf_token }}', 'ops': JSON.stringify(outputs), 'keytimeseries': JSON.stringify(globkeystrokes)},
                            traditional: true,
                            success: function(result) {
                                // console.log(result.result);
                                window.location.href='/preview';
                            }
                        }); 

                      } else
                      if (e.ctrlKey || (e.ctrlKey && keyCode == 65)) {
                      } else {
                        if (keyCode == 39) {
                          $(this).data("right", parseInt($(this).data("right")) + 1)
                        } else
                        if (keyCode == 37) {
                          $(this).data("left", parseInt($(this).data("left")) + 1)
                        } else
                        if (keyCode == 8) {
                          $(this).data("bkspc", parseInt($(this).data("bkspc")) + 1)
                        } else {
                          $(this).data("others", parseInt($(this).data("others")) + 1)
                        }
                        $(this).closest('.bmo').find('.suggest').text('')
                      } 
                      
                    })

                    $('.partial').focusin(function() {

                      timer1 = new Date();
                      $(this).closest('.bmo').removeClass('bmo--blur');
                      $('.partial').closest('.bmo').not($(this).closest('.bmo')).addClass('bmo--blur');
                      
                      $(this).closest('.bmo').find('.suggest').css('visibility', 'visible');
                      placeCaretAtEnd($(this).get(0))
                    });

                    $(".partial").on('focusout',function() {
                      timer2 = new Date();
                      $(this).data("time", timer2 - timer1 + parseInt($(this).data("time")))
                      console.log($(this).data("time"))
                      
                      $(this).closest('.bmo').find('.suggest').css('visibility', 'hidden')
                    })

                    $(".partial").keyup(function(e){
                      var keyCode = e.keyCode || e.which;
                      if (keyCode != 40 && keyCode != 38 && keyCode != 17 && !(e.ctrlKey && keyCode == 65) && keyCode != 35 ) {

                        $(this).closest('.bmo').find('.dropdown').css('visibility', 'hidden');
                      }
                    });

                    $(".hin_inp").focusout(function(){
                      // $('#hin_inp').html(strip($('#hin_inp').html()))
                      // searchEvents($(this));
                    })

                    $("#highlight").change(function(){
                      // $('#hin_inp').html(strip($('#hin_inp').html()))
                      highlight = $(this).is(':checked')
                      if (highlight == false) {
                        $("span[class^='hin_inp_part']").css("background-color", "transparent");
                      }
                    })

                  });
                }); 
        
    </script>
{% endblock %}
{% block content %}
<div class="preloader-background">
    <div class="preloader-wrapper big active">
      <div class="spinner-layer spinner-blue-only">
        <div class="circle-clipper left">
          <div class="circle"></div>
        </div>
        <div class="gap-patch">
          <div class="circle"></div>
        </div>
        <div class="circle-clipper right">
          <div class="circle"></div>
        </div>
        
      </div>
    </div>
    <span>&nbsp;&nbsp;Thank you! Please wait for preview ...</span>
  </div>
    
  <div class="row">
    <div class="col s10">
        <ul class="pagination">
            <li class="waves-effect"><a href="/corpus"  class="white-text"><i class="material-icons">chevron_left</i></a></li>
            <li class="waves-effect"><a href="/corpus" class="white-text">Corpus</a></li>
            <li class="active blue-grey"><a href="/translate" class="white-text">Translate</a></li>
            <li class="waves-effect"><a href="/preview" class="white-text">Submission Preview</a></li>
            <li class="waves-effect"><a href="/preview" class="white-text"><i class="material-icons">chevron_right</i></a></li>
          </ul>
      <div id="cardscoll">
      </div>
      <a class="submittrans waves-effect waves-light btn blue-grey"><i class="material-icons right">send</i>submit</a>
    </div>
  </div>

   {% endblock %}
